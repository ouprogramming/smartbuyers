<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>compare</title>

<script type="text/javascript">
//basenum設定
function setting(){
	userlist = JSON.parse(localStorage.getItem('userlist'));
  username = localStorage.getItem('currentuser');
	shoplist0 = userlist[username][1];
  nos0 = shoplist0.length;
  shoplist1 = shoplist0.filter(function( item ) {
    return item !== "";
  });
  nos1 = shoplist1.length;
}

function directinput(shop,name){
	remove();
	setting();
	var elemname = document.getElementById("name");
	elemname.value = name;
	currentname = name;
	currentshop = Number(shop);
	input();
}

function input(){
	inputvalue = 0;
	inputnum = 1;
	var elemvalue = document.createElement("input");
	var elemnum = document.createElement("input");
	elemvalue.setAttribute("type","number");
	elemnum.setAttribute("type","number");
	elemvalue.setAttribute("class","textboxstyle");
	elemnum.setAttribute("class","textboxstyle");
	elemvalue.setAttribute("id","value");
	elemnum.setAttribute("id","num");
	elemvalue.setAttribute("onkeyup","numCheck()");
	elemnum.setAttribute("onkeyup","numCheck()");
	elemvaluecell = document.getElementById("valuecell");
	elemnumcell = document.getElementById("numcell");
	elemvaluecell.appendChild(elemvalue);
	elemnumcell.appendChild(elemnum);
}

function numCheck(){
	resultTF = true
	inputvalue = Number(document.getElementById("value").value);
	inputnum = Number(document.getElementById("num").value);
	if (inputvalue == 0){
		;
	}else if (inputnum == 0) {
		;
	}else{
		setting();
		basenum0 = userlist[username][2][currentname][0];
		previousvaluelist = userlist[username][2][currentname];
		comparablevalue = (inputvalue*basenum0)/inputnum;
		var TFcount = 0;
		for(var j=1;j<=shoplist0.length;j++){
			if(comparablevalue <= previousvaluelist[j]){
				//子要素セル色緑
				TFcount += 0
				if(currentshop==j){
					var elemresult = document.getElementById("result");
					elemresult.setAttribute("onclick","update()");
					elemresult.textContent = "更新";
					resultTF = false;
				}else{
					;
				}
			}else{
				//子要素セル色赤
				TFcount += 1;
			}

		}
		elemresult = document.getElementById("result");
		if(TFcount==0){
			elemresult.style.backgroundColor = "#9BE585";
			elemresult.style.color = "#38742A";
			result("◯");
		}else if(TFcount > 0 && TFcount < nos0){
			elemresult.style.backgroundColor = "#F7F1AC";
			elemresult.style.color = "#F27200";
			result("△");
		}else{
			elemresult.style.backgroundColor = "#EDD1E4";
			elemresult.style.color = "#DA3B26";
			result("×");
		}

	}
}

function result(sign){
	if(resultTF){
		elemresult = document.getElementById("result");
		elemresult.textContent = sign;
	}else{
		;
	}
}

function update(){
	alert("update");
	userlist = JSON.parse(localStorage.getItem('userlist'));
  username = localStorage.getItem('currentuser');
	userlist[username][2][currentname][currentshop] = comparablevalue;
	localStorage.setItem('userlist', JSON.stringify(userlist));
	document.getElementById("table").contentWindow.mktable();
}

function nameCheck(){
	currentshop = "0"
	remove();
	elemresult = document.getElementById("result");
	userlist = JSON.parse(localStorage.getItem('userlist'));
  username = localStorage.getItem('currentuser');
	var grocerydict =  userlist[username][2];
	var grocerylist = Object.keys(grocerydict);
	var inputname = document.getElementById("name").value;
	currentname = inputname;
	if(grocerylist.indexOf(inputname) == -1){
		var elemresult = document.getElementById("result");
		elemresult.setAttribute("onclick","register()");
		elemresult.textContent = "追加";
		var elemnum = document.createElement("input");
		elemnum.setAttribute("type","number");
		elemnum.setAttribute("class","textboxstyle");
		elemnum.setAttribute("id","num");
		var elemnumcell = document.getElementById("numcell");
		elemnumcell.appendChild(elemnum);
		registerTF = false;
	}else{
		input();
	}
}
function register(){
	alert("register")
	userlist = JSON.parse(localStorage.getItem('userlist'));
  username = localStorage.getItem('currentuser');
	basenum1 = Number(document.getElementById("num").value);
	userlist[username][2][currentname] = [basenum1,null,null,null];
	localStorage.setItem('userlist', JSON.stringify(userlist));
	remove();
	document.getElementById("table").contentWindow.mktable();
}

function remove(){
	try{
		var elemresult = document.getElementById("result");
		elemresult.style.backgroundColor = "#FFFFFF";
		elemresult.style.color = "#000000";
		elemresult.textContent = "";
		elemresult.setAttribute("onclick","");
	}catch{
		;
	}
	try{
		var elemnum = document.getElementById("num");
		elemnum.setAttribute("value",0);
		elemnum.remove();
	}catch{
		;
	}
	try{
		var elemresult = document.getElementById("result");
		elemresult.textContent = "";
	}catch{
		;
	}
	try{
		var elemvalue = document.getElementById("value");
		elemvalue.setAttribute("value",0);
		elemvalue.remove();
	}catch{
		;
	}
}

</script>
<style>

.body{
	margin:0;
}

.tablestyle1{
	height:20vh;
	width:100vw;
	padding: 0em;
	table-layout: fixed;
}
.tablestyle2{
	height:80vh;
	width:100vw;
	padding: 0em;
}
.tdstyle1{
	height:100%;
	width:50%;
	padding: 0em;
}
.tdstyle2{
	height:100%;
	width:(50/3)%;
	padding: 0em;
}
.textboxstyle{
	display: block;
	height:100%;
	width:100%;
	padding: 0em 0em;
	font-size:400%;
}
.boxstyle{
	display: block;
	height:100%;
	width:100%;
	padding: 0em 0em;
	font-size:400%;
}
.updatebtn{
	padding: 0em 0em;
	height:100%;
	width:100%;
}
</style>
</head>
<body>
<header>
<table class="tablestyle1">
<tr>
<td class="tdstyle1"><input type="text" class="textboxstyle" id="name" onkeyup="nameCheck()"></input></td>
<td class="tdstyle2" id="valuecell"></input></td>
<td class="tdstyle2" id="numcell"></input></td>
<td class="tdstyle2" id="result"></td>
</tr>
</table>
</header>
<iframe src="table.html" class="tablestyle2" id="table"></iframe>
</body>
</html>
