<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>compare</title>

<script type="text/javascript">
//basenum設定
function start(){
	var select = document.createElement('select');
	select.setAttribute("id","select");
	select.setAttribute("name","shop");
	preparation();
	var option = document.createElement('option');
	option.setAttribute("value","指定なし");
	option.setAttribute("label","指定なし");
	select.appendChild(option)
	for(i=0;i<nos0;i++){
		if(shoplist0[i]!==""){
			var option = document.createElement('option');
			option.setAttribute("value",shoplist0[i]);
			option.setAttribute("label",shoplist0[i]);
			select.appendChild(option);
		}else{
			;
		}
	}
	document.getElementById("selectcell").appendChild(select);
}
function directinput(shop,name){
	remove();
	preparation();
	var elemname = document.getElementById("name");
	elemname.value = name;
	currentname = name;
	currentshop = Number(shop);
	input();
}

function nameCheck(){
	currentshop = "0"
	remove();
	preparation();
	var	elemresult = document.getElementById("result");
	var inputname = document.getElementById("name").value;
	currentname = inputname;
	if(grocerylist.indexOf(inputname) == -1){
		var elemupdatecell = document.getElementById("updatecell");
		elemupdatecell.setAttribute("onclick","register()");
		elemupdatecell.textContent = "追加";
		var elemnum = document.createElement("input");
		elemnum.setAttribute("type","number");
		elemnum.setAttribute("class","textboxstyle");
		elemnum.setAttribute("id","num");
		elemnum.setAttribute("placeholder","個/g");
		var elemnumcell = document.getElementById("numcell");
		elemnumcell.appendChild(elemnum);
	}else{
		input();
	}
}
function numCheck(){
	resultTF = true
	inputvalue = Number(document.getElementById("value").value);
	inputnum = Number(document.getElementById("num").value);
	if (inputvalue == 0){
		;
	}else if (inputnum == 0) {
		;
	}else{
		preparation();
		basenum0 = userlist[username][2][currentname][0];
		previousvaluelist = userlist[username][2][currentname];
		comparablevalue = (inputvalue*basenum0)/inputnum;
		var TFcount = 0;
		for(var j=1;j<=shoplist0.length;j++){
			var id0 = j.toString()+currentname;
			if(comparablevalue <= previousvaluelist[j]){
				TFcount += 0
				document.getElementById("table").contentWindow.color(id0,"#38742A","#9BE585");
				if(currentshop==j && comparablevalue<=previousvaluelist[j]){
					var elemupdatecell = document.getElementById("updatecell");
					elemupdatecell.setAttribute("onclick","update()");
					elemupdatecell.textContent = "更新";
				}else{
					;
				}
			}else if(currentshop==j && previousvaluelist[j]==null){
				document.getElementById("table").contentWindow.color(id0,"#38742A","#9BE585");
				var elemupdatecell = document.getElementById("updatecell");
				elemupdatecell.setAttribute("onclick","update()");
				elemupdatecell.style.color = "#38742A"
				elemupdatecell.style.backgroundColor = "#9BE585";
				elemupdatecell.textContent = "更新";
			}else{
				document.getElementById("table").contentWindow.color(id0,"#DA3B26","#EDD1E4");
				TFcount += 1;
			}
		}
		elemresult = document.getElementById("result");
		if(TFcount==0){
			elemresult.style.color = "#38742A";
			elemresult.style.backgroundColor = "#9BE585";
			elemresult.textContent = "◯";
		}else if(TFcount > 0 && TFcount < nos0){
			elemresult.style.color = "#F27200";
			elemresult.style.backgroundColor = "#F7F1AC";
			elemresult.textContent = "△";
		}else{
			elemresult.style.color = "#DA3B26";
			elemresult.style.backgroundColor = "#EDD1E4";
			elemresult.textContent = "×";
		}
	}
}

function preparation(){
	userlist = JSON.parse(localStorage.getItem('userlist'));
  username = localStorage.getItem('currentuser');
	shoplist0 = userlist[username][1];
  nos0 = shoplist0.length;
  shoplist1 = shoplist0.filter(function( item ) {
    return item !== "";
  });
  nos1 = shoplist1.length;
	grocerydict =  userlist[username][2];
	grocerylist = Object.keys(grocerydict);
}

function input(){
	inputvalue = 0;
	inputnum = 1;
	var elemvalue = document.createElement("input");
	var elemnum = document.createElement("input");
	elemvalue.setAttribute("type","number");
	elemnum.setAttribute("type","number");
	elemvalue.setAttribute("class","textboxstyle");
	elemnum.setAttribute("class","textboxstyle");
	elemvalue.setAttribute("id","value");
	elemnum.setAttribute("id","num");
	elemvalue.setAttribute("onkeyup","numCheck()");
	elemnum.setAttribute("onkeyup","numCheck()");
	elemvalue.setAttribute("placeholder","値段");
	elemnum.setAttribute("placeholder","個/g");
	elemvaluecell = document.getElementById("valuecell");
	elemnumcell = document.getElementById("numcell");
	elemvaluecell.appendChild(elemvalue);
	elemnumcell.appendChild(elemnum);
}

function update(){
	userlist = JSON.parse(localStorage.getItem('userlist'));
  username = localStorage.getItem('currentuser');
	userlist[username][2][currentname][currentshop] = Math.round(comparablevalue);
	localStorage.setItem('userlist', JSON.stringify(userlist));
	document.getElementById("table").contentWindow.rmtable();
	document.getElementById("table").contentWindow.mktable();
}


function register(){
	userlist = JSON.parse(localStorage.getItem('userlist'));
  username = localStorage.getItem('currentuser');
	basenum1 = Number(document.getElementById("num").value);
	userlist[username][2][currentname] = [Math.round(basenum1),null,null,null];
	localStorage.setItem('userlist', JSON.stringify(userlist));
	remove();
	document.getElementById("table").contentWindow.rmtable();
	document.getElementById("table").contentWindow.mktable();
	input();
}

function remove(){
	try{
		preparation();
		index = grocerylist.indexOf(currentname);
		if (index%2 ==0){
			back = "#ffffff";
		}else{
			back = "#dfdfdf";
		}
		for(var j=1;j<=nos0;j++){
			var id1 = j.toString()+currentname;
			document.getElementById("table").contentWindow.color(id1,"#000000",back);
		}
	}catch{
		;
	}
	try{
		var elemupdatecell = document.getElementById("updatecell");
		elemelemupdatecell.style.backgroundColor = "#FFFFFF";
		elemelemupdatecell.style.color = "#000000";
		elemelemupdatecell.textContent = "";
		elemelemupdatecell.setAttribute("onclick","");
	}catch{
		;
	}
	try{
		var elemresult = document.getElementById("result");
		elemresult.style.backgroundColor = "#FFFFFF";
		elemresult.style.color = "#000000";
		elemresult.textContent = "";
	}catch{
		;
	}
	try{
		var elemnum = document.getElementById("num");
		elemnum.setAttribute("value",0);
		elemnum.remove();
	}catch{
		;
	}
	try{
		var elemresult = document.getElementById("result");
		elemresult.textContent = "";
	}catch{
		;
	}
	try{
		var elemvalue = document.getElementById("value");
		elemvalue.setAttribute("value",0);
		elemvalue.remove();
	}catch{
		;
	}
}

</script>
<style>

.body{
	margin:0;
}

.tablestyle1{
	height:20vh;
	width:100vw;
	padding: 0em;
	table-layout: fixed;
}
.tablestyle2{
	height:80vh;
	width:100vw;
	padding: 0em;
}
.tdstyle1{
	height:100%;
	width:50%;
	padding: 0em;
}
.tdstyle2{
	height:100%;
	width:(50/3)%;
	padding: 0em;
}
.textboxstyle{
	display: block;
	height:100%;
	width:100%;
	padding: 0em 0em;
	font-size:400%;
}
.boxstyle{
	display: block;
	height:100%;
	width:100%;
	padding: 0em 0em;
	font-size:400%;
}
.updatebtn{
	padding: 0em 0em;
	height:100%;
	width:100%;
}
</style>
</head>
<body onload="start()">
<header>
<table class="tablestyle1">
<tr>
<td class="tdstyle3" onclick="clear()">クリア</td>
<td class="tdstyle3" onclick="setting()">設定</td>
<td class="tdstyle3" id="selectcell"></td>
<td class="tdstyle3" id="updatecell"></td>
</tr>
<tr>
<td class="tdstyle1"><input type="text" class="textboxstyle" id="name" onkeyup="nameCheck()"></input></td>
<td class="tdstyle2" id="valuecell"></input></td>
<td class="tdstyle2" id="numcell"></input></td>
<td class="tdstyle2" id="result"></td>
</tr>
</table>
</header>
<iframe src="table.html" class="tablestyle2" id="table"></iframe>
</body>
</html>
